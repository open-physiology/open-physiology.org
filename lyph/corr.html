<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="author" content="The Farr Institute">
    <title>Correlations Tool</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="Lyph API correlations frontend">

    <link rel="stylesheet" href="http://open-physiology.org/Skeleton/stylesheets/base.css">
    <link rel="stylesheet" href="http://open-physiology.org/Skeleton/stylesheets/skeleton.css">
    <link rel="stylesheet" href="http://open-physiology.org/index.css">
<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">

    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Google Analytics Script-->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-58380934-1', 'auto');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    
	<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
	<script>
      function reset_inputs()
      {
        g("annot_pubmed").value="";
        g("annot_lyphs").value="";
        g("annot_obj").value="";
      }

      function lyphsearch()
      {
        var srch = g("lyphsearch").value.trim();
        if ( srch === "" )
          return;
        var url = "http://open-physiology.org:5055/lyphs_by_prefix/?prefix=";
        url += encodeURIComponent( srch );

        $.ajax(
        {
          "url": url,
          "dataType": "jsonp",
          "success": function(result)
          {
            if ( result.hasOwnProperty("Error") )
            {
              alert("Error: " + result["Error"]);
              return;
            }

            var html = "";
            for ( var i = 0; i < result.length; i++ )
            {
              html += "<h4>ID: " + result[i]["id"] + "</h4>";
              if ( result[i]["name"] !== null )
                html += "<span>" + result[i]["name"] + "</span>" + "<br>";
              if ( result[i]["template"] !== null )
              {
                html += "<span>Template: " + result[i]["template"]["id"];
                if ( result[i]["template"]["name"] !== null )
                  html += " (" + result[i]["template"]["name"] + ")";

                html += "</span>"                
              }
              html += "</id>";
            }
            g("searchresults").innerHTML = html;
            g("lyphsearch").value="";
          }
        });
      }

      function annotate()
      {
        var pubmedbox = g("annot_pubmed");
        var lyphsbox = g("annot_lyphs");
        var objbox = g("annot_obj");

        if ( pubmedbox.value.trim() === "" )
        {
          alert("Please indicate a Pubmed ID");
          return;
        }
        if ( lyphsbox.value.trim() === "" )
        {
          alert("Please indicate a comma-separated list of lyphs");
          return;
        }

        var url = "http://open-physiology.org:5055/makecorrelation/";
        url += "?pubmed=" + encodeURIComponent(pubmedbox.value.trim());

        var lyphsstr = lyphsbox.value.split(",").map(function(currentValue,index,array)
        {
          return currentValue.trim();
        }).join(",");

        url += "&vars=" + encodeURIComponent(lyphsstr);

        $.ajax(
        {
          "url": url,
          "dataType": "jsonp",
          "success": function(result)
          {
            if ( result.hasOwnProperty("Error") )
            {
              alert("Error: " + result["Error"]);
              return;
            }
            var html = bulk_annot_to_html(result);
            g("bulk_annot_list").innerHTML = html + "<br>" + g("bulk_annot_list").innerHTML;
            reset_inputs();
          }
        });
      }

      function g(x){ return document.getElementById(x); }

      $(function()
      {
        $.ajax(
	{
	  "url": "http://open-physiology.org:5055/all_correlations/",
	  "success": function(result)
	  {
	    var annotlist = "";
	    
	    for ( var i = 0; i < result.length; i++ )
	      annotlist += bulk_annot_to_html( result[i] ) + "<br>";
	    
	    document.getElementById("bulk_annot_list").innerHTML = annotlist;
	  },
	  "dataType": "jsonp"
	});
      });
      
      function variable_to_html( x )
      {
        if ( x["type"] === "clinical index" )
        {
          if ( x["clindex"] === x["clindex label"] )
            return x["clindex"];
          else
            return x["clindex label"] + " (" + x["clindex"] + ")";
        }
        else if ( x["type"] === "located measure" )
        {
          var retval = x["quality"] + " of ";

          if ( x["location name"] !== null )
            retval += x["location name"];
          else
            retval += "lyph " + x["location"];

          return retval;
        }
        return "(Unknown?)";
      }

      function bulk_annot_to_html( x )
      {
        var retval = "";
	retval += "<div>";
	retval += "<h4 style='margin-left:10px'>Correlation " + x["id"];
	
	retval += " (PMID: " + x["pubmed"]["id"] + ")</h4>";
	retval += "(<a target='blank' href='http://open-physiology.org:5055/delete_correlation/?corr="+x["id"]+"'>Delete</a>)";

        retval += "<ul>";
        var valind;
        for ( valind = 0; valind < x["variables"].length; valind++ )
          retval += "<li>"+variable_to_html(x["variables"][valind])+"</li>";
        retval += "</ul>";

	retval += "</div>";
	return retval;
      }


 $(function() {

        $( "#lyphsearch" ).autocomplete({
            source: function( request, response ) {
                $.ajax({
                    url: "http://open-physiology.org:5055/lyphs_by_prefix/?prefix=" + request.term,
                    dataType: "jsonp",
                    data: {
                        q: request.term
                    },
                    success: function( data ) {

                        var returnedLyphs = [];

                        for (var i =0; i < data.length; i ++) {
                            returnedLyphs.push({label:data[i].name, id:data[i].id});

                        }

                        response(returnedLyphs);
                    }
                });
            },
            minLength: 0,
            select: function( event, ui ) {
              lyphsearch();
	    },
            open: function() {
                $( this ).removeClass( "ui-corner-all" ).addClass( "ui-corner-top" );
            },
            close: function() {
                $( this ).removeClass( "ui-corner-top" ).addClass( "ui-corner-all" );
            }
        });
    });

    </script>
    
  </head>
  <body>
    <div class="container" id="maindiv">
      <div id="leftdiv" class="eleven columns">
        <div class="floating-box" id="headerdiv">
          <h2 id='openphysiology'>Correlations</h2>
        </div>

        <div class="floating-box" id="imagediv" style="position:relative;">
          <div id="bulk_annot_form" style='margin-top:10px'>
	    <input id='annot_pubmed' placeholder='Pubmed ID' style='width:45%; display:inline'/>
            &nbsp; &raquo;
            <a target='_blank' href='http://open-physiology.org:5055/reset_db/?correlations=yes'>Delete all correlations</a>
            &nbsp; Or &raquo;
            <a target='_blank' href='http://open-physiology.org:5055/get_csv/?what=correlations'>Get correlations.csv</a>
	    <br>
	    &nbsp; <input id='annot_lyphs' placeholder='Variables (comma-separated)' style='width:95%'/>
	    <br>
	    &nbsp; <button style='width:95%; margin-top:10px' onclick='annotate()'>Annotate</button>
	  </div>
          <div id="bulk_annot_list" style="height:300px; overflow:auto">
            Loading...
          </div>
        </div>
      </div>

      <div class="five columns floating-box" id="rightdiv" style="height:100%; margin-top: 15px">
       <div class="floating-contents" style="height:507px">
        <h3 id='home'>Lyph Search</h3>
        <div id='homediv' class='tabs'>
          <input id='lyphsearch' style='width:97%'/>
	  <button style='width:100%; margin-top:5%' onclick='lyphsearch()'>Search for lyphs</button>
          <hr>
          <div id='searchresults' style='height:100%; overflow: auto'>
          </div>
        </div>
       </div>
      </div>

    </div>
  </body>
</html>
